% AUTOMATICALLY INSERTED SLIDES

\makeatletter
\AtBeginPart{%
	\beamer@tocsectionnumber=0\relax
	\setcounter{section}{0}
	\setcounter{framenumber}{0}
}
\makeatother

\AtBeginLecture{
	\part{}
	\subtitle{\insertlecturenumber. \insertlecture}

	\contentoverview

	\mode<beamer>{
		\addtocounter{framenumber}{-1}
		\ifdefined\thepicture
			\maketitle[\thepicture][\thepictureoffset]
		\else
			\maketitle[]
		\fi

		\addtocounter{framenumber}{-1}
		\begin{frame}{\inserttitle} % TODO avoid this page for first lecture?
			\lectureseriesoverview[\insertlecturenumber]
		\end{frame}

		\addtocounter{framenumber}{-1}
		\begin{frame}{\insertsubtitle}
	        \vfill
			\setbeamerfont{section in toc}{size=\LARGE}
			\tableofcontents[hideallsubsections]
		\end{frame}
	}
}

\AtBeginSection{
	\mode<handout>{
	    \begin{frame}{\insertsubtitle}
	        \linespread{.5}
	        \vfill
	        \tableofcontents[currentsection,hideothersubsections]
	    \end{frame}
	}
	\mode<beamer>{
		\begin{frame}{\insertsubtitle}
	        \vfill
			\setbeamerfont{section in toc}{size=\LARGE}
			\tableofcontents[currentsection,hideallsubsections]
		\end{frame}
	}
}

% HACKS TO WORKAROUND PROBLEMS WITH THE TEMPLATE

% TODO would be great if the footer links to the respective current lecture

% emphasizing links
\hypersetup{linkcolor=black, citecolor=red, filecolor=red, runcolor=red, urlcolor=red, colorlinks=true}

% load href target from file: \href{file.txt}{text}
\newcommand\hreffile[1]{%
	\CatchFileDef\myurl{#1}{\catcode`\#=12\catcode`\%=12\endlinechar=-1}%
	\expandafter\href\expandafter{\myurl}}
\newcommand{\pic}[2][]{%
	\IfFileExists{#2.txt}{\hreffile{#2.txt}}{}{\includegraphics[#1]{#2}}}

% TODO hack to switch the lecture title with its subtitle on the title slide + add photo copyright notice
\makeatletter
\setbeamercolor{copyrightbox}{fg=white}
\renewcommandx{\maketitle}[2][1=apr21-o25a,2=150]{
    {
    \def \picture {#1}
    \ifx \picture \empty \else \usebackgroundtemplate{\pic[trim=0 0 0 #2,clip,width=\paperwidth]{#1}} \fi
    \begin{frame}[plain]
        \vskip0pt plus 1filll
		\begin{beamercolorbox}[wd=\paperwidth,ht=2.25ex,dp=1ex,left]{copyrightbox}
            \tiny
			\ifdefined\thecopyright
				\hspace{1mm}\thecopyright
			\fi
        \end{beamercolorbox}%
        \begin{beamercolorbox}[wd=\paperwidth,ht=4.5ex,dp=2ex,right]{titlebox}
            \LARGE\textbf{\insertsubtitle}\hspace*{20pt}
        \end{beamercolorbox}%
        \nointerlineskip%
		\begin{beamercolorbox}[wd=\paperwidth,ht=2.25ex,dp=1ex,right]{subtitlebox}
            \small
            \inserttitle\ $\vert$
            \insertauthor\
            \ifx \insertdate \empty \else $\vert$ \insertdate \fi
            \hspace*{20pt}
        \end{beamercolorbox}%
        \nointerlineskip
        \begin{beamercolorbox}[wd=\paperwidth,ht=4.5ex,dp=2ex,left]{logobox}
            \vspace{-1ex}%
            \hspace{10pt}
            \@mainlogo
            \hspace{10pt}
        \end{beamercolorbox}%
    \end{frame}
    }
}
\makeatother

\makeatletter
\renewcommand{\contentoverview}{
    \begin{frame}[plain]
		\label{lecture\insertlecturenumber}
        \setbeamerfont{section in toc}{size=\small}\setbeamerfont{subsection in toc}{size=\footnotesize}
		\begin{beamercolorbox}[wd=.95\paperwidth,ht=28ex,dp=2ex]{lectureseries}
			{\footnotesize\lectureseriesoverview[\insertlecturenumber]}
        \end{beamercolorbox}
		\begin{beamercolorbox}[wd=.95\paperwidth,ht=12ex,dp=2ex]{lecture}
			\begin{mycolumns}[t,columns=3,animation=none]
				\setlength{\parskip}{.5ex}\tableofcontents[sections={1}]
			\mynextcolumn
				\setlength{\parskip}{.5ex}\tableofcontents[sections={2}]
			\mynextcolumn
				\setlength{\parskip}{.5ex}\tableofcontents[sections={3}]
			\end{mycolumns}
        \end{beamercolorbox}
        \vskip0pt plus 1filll
        \mode<beamer>{\begin{beamercolorbox}[wd=\paperwidth,ht=4.5ex,dp=2ex,right]{titlebox}
            \LARGE\textbf{\insertsubtitle}\hspace*{20pt}
        \end{beamercolorbox}}%
        \mode<handout>{\begin{beamercolorbox}[wd=\paperwidth,ht=4.5ex,dp=2ex,right]{titlebox}
            \LARGE\textbf{\insertsubtitle\ -- Handout}\hspace*{20pt}
        \end{beamercolorbox}}%
        \nointerlineskip%
		\begin{beamercolorbox}[wd=\paperwidth,ht=2.25ex,dp=1ex,right]{subtitlebox}
            \small
            \inserttitle\ $\vert$
            \insertauthor\
            \ifx \insertdate \empty \else $\vert$ \insertdate \fi
            \hspace*{20pt}
        \end{beamercolorbox}%
        \nointerlineskip
        \begin{beamercolorbox}[wd=\paperwidth,ht=4.5ex,dp=2ex,left]{logobox}
            \vspace{-1ex}%
            \hspace{10pt}
            \@mainlogo
            \hspace{10pt}
        \end{beamercolorbox}%
    \end{frame}
}
\makeatother
% TODO remove the two commands below, as we do not seem to need them anymore
%\newcommand{\sectionend}{\addtocontents{toc}{\vspace{2mm}}}
\newcommand{\sectionend}{\addtocontents{toc}{}}

% change section numbers to letters
% https://tex.stackexchange.com/questions/268024/numbering-by-letters-in-beamer-table-of-contents
%\newcommand{\lecturenumber}[1]{\newcommand{\insertlecturenumber}{#1}}
\renewcommand{\thesection}{\insertlecturenumber\alph{section}}
\defbeamertemplate{subsection in toc}{bullets}{%
  \parbox[t]{1em}{\textbullet\hfill}%
  \parbox[t]{\dimexpr\textwidth-1em\relax}{\inserttocsubsection}\par}
\makeatletter
\defbeamertemplate{section in toc}{sections numbered roman}{%
  \insertlecturenumber\@alph\inserttocsectionnumber.\ %
  \inserttocsection\par}
\makeatother
\setbeamertemplate{section in toc}[sections numbered roman]

% TODO merge into template?
% automatic frame title
\newcommand{\myframetitle}{\insertsubsection{}\ifnum\thesubsubsection=0\else\ -- \insertsubsubsection{}\fi}
% frame icon on fixed position in upper right corner
\newcommand{\myframeicon}[1]{ % TODO needs to be revised: ideally aligned with absolute positioning, such that it can be used at the end of the slide content (potentially drawn on top of the slide content if needed)
	\begin{textblock*}{1.07\textwidth}(0.035\textwidth,0\textwidth)
		\begin{flushright}
			#1
		\end{flushright}
	\end{textblock*}
}
% setter for title picture + copyright notice
\newcommand{\setpicture}[2][150]{\def\thepicture{#2}\def\thepictureoffset{#1}}
\newcommand{\setcopyright}[1]{\def\thecopyright{#1}}
\newcommand{\picborder}[1]{{\setlength{\fboxsep}{0pt}\setlength{\fboxrule}{.75pt}\fcolorbox{uulmaccent}{white}{#1}}}

% TODO improve itemize + enumerate margins
\setlength{\leftmargini}{2.5ex}
% \setbeamertemplate{enumerate item}{\makebox[.5\labelwidth][l]{\insertenumlabel.}}

% TODO add reference slide at the end for picture licenses
